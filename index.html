<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Mismatch - বারকোড স্ক্যানার</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Barcode Scanner Library: Loading this globally so the main script can access it -->
    <script src="https://unpkg.com/html5-qrcode@2.3.9/umd/html5-qrcode.js"></script>
    <style>
        /* Custom styles for disabled elements */
        :disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Hide number input spinners (for Scan Qty) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for active tab */
        .tab-active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
        }

        /* --- New/Updated Scanner Styling for Barcode Look --- */
        #scanner-container {
            /* Restrict the size of the container to mimic a focused scanner view */
            width: 100%;
            max-width: 400px;
            height: 300px; /* Fixed height for consistent look */
            margin: 0 auto;
            position: relative;
            overflow: hidden; /* Important to keep the video stream within bounds */
            border: 2px solid #3b82f6; /* Blue border */
            border-radius: 8px;
        }

        #qr-reader video {
            /* Ensure the video fills the container, maintaining aspect ratio */
            object-fit: cover;
            width: 100%;
            height: 100%;
        }

        /* Overlay for the red scanning line */
        .scanner-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: red;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            transform: translateY(-50%);
            animation: scan-move 2s infinite alternate;
            pointer-events: none; /* Allows clicks to pass through */
        }

        @keyframes scan-move {
            0% { top: 20%; }
            100% { top: 80%; }
        }
        /* --- End Scanner Styling --- */
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-gray-800 text-center">ইনভেন্টরি অমিল পরীক্ষা (Inventory Mismatch Checker)</h1>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 md:p-8">

        <!-- Barcode Scanner Section -->
        <section id="scanner-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">বারকোড স্ক্যান করুন (Scan Barcode)</h2>
            
            <!-- Scanner Container with Barcode-like visual -->
            <div id="scanner-container">
                <div id="qr-reader" style="width:100%;"></div>
                <!-- Red scanning line overlay -->
                <div class="scanner-line"></div>
            </div>
            
            <p id="scan-result" class="text-center text-sm mt-4 text-gray-500">স্ক্যান শুরু হতে একটু সময় লাগতে পারে। অনুগ্রহ করে ক্যামেরার অনুমতি দিন।</p>
        </section>

        <!-- Product Details / Manual Entry Section -->
        <section id="entry-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">পণ্যের তথ্য (Product Details)</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="scanned-sku" class="block text-sm font-medium text-gray-700">স্ক্যান করা SKU (Scanned SKU)</label>
                    <input type="text" id="scanned-sku" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 font-mono text-gray-800">
                </div>
                <div>
                    <label for="actual-qty" class="block text-sm font-medium text-gray-700">প্রকৃত পরিমাণ (Actual Qty)</label>
                    <input type="number" id="actual-qty" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="স্টকে থাকা পরিমাণ">
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="check-btn" onclick="checkMismatch()" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    অমিল পরীক্ষা করুন (Check Mismatch)
                </button>
            </div>
        </section>
        
        <!-- Status Log Section -->
        <section id="log-section" class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">স্ট্যাটাস লগ (Status Log)</h2>
            <div id="log-container" class="space-y-2 max-h-64 overflow-y-auto p-3 border border-gray-200 rounded-lg bg-gray-50">
                <!-- Log entries will be added here -->
            </div>
        </section>

    </main>
    
    <!-- JavaScript Logic -->
    <script>
        // NOTE: type="module" has been removed to fix the ReferenceError: Html5QrcodeScanner is not defined.
        // Global variables for Firebase setup (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Note: Firestore is not used in this simple client-side scanner example, but the boilerplate is kept for compliance.
        // Importing only essential libraries for a simple app to run.
        // We will focus on the scanner logic first.

        // Global variables
        let html5QrcodeScanner;
        const SCAN_INTERVAL_MS = 3000; // Time to wait before enabling next scan after success (3 seconds)

        // --- Utility Functions ---

        /**
         * Plays a short, distinct beep sound.
         * Uses Web Audio API.
         */
        function playBeepSound() {
            try {
                // Check if AudioContext is supported
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) {
                    console.warn("Web Audio API not supported. Cannot play beep sound.");
                    return;
                }
                
                const audioContext = new AudioContext();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Configure the sound
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5 note
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); // Volume
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15); // Quick fade out

                // Start and stop the sound
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15); 
            } catch (e) {
                console.warn("Could not play beep sound.", e);
            }
        }

        /**
         * Shows a temporary status message in a fixed position. (Custom alert replacement)
         */
        function showTemporaryMessage(message, type = 'blue') {
            let colorClass = 'bg-blue-600';
            if (type === 'red') colorClass = 'bg-red-600';
            if (type === 'green') colorClass = 'bg-green-600';
            
            let messageBox = document.getElementById('temp-message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'temp-message-box';
                messageBox.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-500 z-50';
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-500 z-50 ${colorClass} opacity-100`;

            clearTimeout(messageBox.timeout);
            messageBox.timeout = setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        /**
         * Adds an entry to the log container.
         */
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('p');
            
            let color = 'text-gray-700';
            if (type === 'success') color = 'text-green-600 font-semibold';
            if (type === 'error') color = 'text-red-600 font-semibold';
            if (type === 'warn') color = 'text-yellow-600';

            const timestamp = new Date().toLocaleTimeString();
            logEntry.className = `text-sm ${color} p-2 bg-white rounded-md shadow-sm`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            // Prepend new log entry
            logContainer.prepend(logEntry);
            // Limit log entries to 10 for performance/readability
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // --- Scanner Logic ---

        /**
         * This function is called every time a barcode is successfully scanned.
         */
        function onScanSuccess(decodedText, decodedResult) {
            // 1. Stop the scanner immediately to prevent multiple rapid scans
            html5QrcodeScanner.pause(true); 
            
            // 2. Play the success sound (New Feature)
            playBeepSound(); 

            // 3. Update the UI with the scanned SKU
            document.getElementById('scanned-sku').value = decodedText;
            document.getElementById('scan-result').textContent = `স্ক্যান সফল: ${decodedText} - অমিল পরীক্ষার জন্য প্রস্তুত।`;
            addLog(`বারকোড স্ক্যান সফল: ${decodedText}`, 'success');
            showTemporaryMessage(`স্ক্যান সফল: ${decodedText}`, 'green');

            // 4. Automatically re-start the scanner after a short delay (New Feature)
            // This prepares the scanner for the next item.
            setTimeout(() => {
                html5QrcodeScanner.resume();
                document.getElementById('scan-result').textContent = 'পরবর্তী স্ক্যানের জন্য প্রস্তুত...';
            }, SCAN_INTERVAL_MS); 

            // Note: The mismatch check is still manual via the button for user control
        }

        /**
         * Function to handle when the scanner fails to decode a frame. (Optional)
         */
        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
            // No need to spam the log, just keep the UI simple.
        }
        
        /**
         * Initializes and starts the barcode scanner.
         */
        function startScanner() {
            // Check if the global Html5QrcodeScanner is defined (the library load was successful)
            if (typeof Html5QrcodeScanner === 'undefined') {
                document.getElementById('scan-result').textContent = 'ত্রুটি: স্ক্যানার লাইব্রেরি লোড হতে পারেনি।';
                showTemporaryMessage('গুরুত্বপূর্ণ ত্রুটি: ক্যামেরা স্ক্যানার শুরু করা যায়নি।', 'red');
                return;
            }

            if (html5QrcodeScanner) {
                // If scanner already exists, just return or handle re-initialization if needed
                return;
            }

            // Create the scanner instance for the element ID 'qr-reader'
            // Added facingMode: "environment" to prioritize the back camera for mobile scanning
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", 
                { 
                    fps: 10, // Frames per second
                    qrbox: { width: 250, height: 100 }, // Focused scan box (more barcode-like)
                    facingMode: "environment" // CRITICAL for mobile back camera
                },
                /* verbose= */ false
            );
            
            // Start the scanner
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);

            // Optional: Listen to the start event to update initial message
            setTimeout(() => {
                 document.getElementById('scan-result').textContent = 'ক্যামেরা চালু হয়েছে। অনুগ্রহ করে বারকোড স্ক্যান করুন।';
            }, 3000); // Wait a bit for the camera to initialize
        }

        // --- Inventory Mismatch Check Logic (Mock Data) ---

        const MOCK_INVENTORY_DATA = {
            "SKU12345": { name: "Red Widget", inventory: 10 },
            "SKU67890": { name: "Blue Gadget", inventory: 5 },
            "8901021010101": { name: "Product A", inventory: 2 }, // Sample barcode
            "456789012345": { name: "Product B", inventory: 15 }, // Sample barcode
        };

        function checkMismatch() {
            const scannedSkuInput = document.getElementById('scanned-sku');
            const actualQtyInput = document.getElementById('actual-qty');

            const scannedSku = scannedSkuInput.value.trim();
            const actualQty = parseInt(actualQtyInput.value, 10);

            if (!scannedSku) {
                showTemporaryMessage('স্ক্যান করার জন্য কোনো SKU পাওয়া যায়নি।', 'red');
                return;
            }
            if (isNaN(actualQty) || actualQty < 1) {
                showTemporaryMessage('প্রকৃত পরিমাণ অবশ্যই ১ বা তার বেশি হতে হবে।', 'red');
                return;
            }

            // Mock database lookup
            const productData = MOCK_INVENTORY_DATA[scannedSku];
            
            if (!productData) {
                // Not found in inventory
                addLog(`SKU: ${scannedSku} ইনভেন্টরিতে পাওয়া যায়নি।`, 'error');
                showTemporaryMessage(`SKU: ${scannedSku} ইনভেন্টরিতে অনুপস্থিত।`, 'red');
                return;
            }

            // Check for mismatch
            const systemQty = productData.inventory;
            const productName = productData.name;
            
            if (actualQty === systemQty) {
                // Match
                const message = `${productName} (SKU: ${scannedSku}): মিলেছে! সিস্টেম Qty: ${systemQty}, প্রকৃত Qty: ${actualQty}`;
                addLog(message, 'success');
                showTemporaryMessage('সম্পূর্ণ মিলেছে!', 'green');
            } else {
                // Mismatch
                const diff = actualQty - systemQty;
                const message = `${productName} (SKU: ${scannedSku}): অমিল! সিস্টেম Qty: ${systemQty}, প্রকৃত Qty: ${actualQty}. পার্থক্য: ${diff}`;
                addLog(message, 'warn');
                showTemporaryMessage(`অমিল পাওয়া গেছে! পার্থক্য: ${diff}`, 'red');
            }
            
            // Reset quantity input for next check
            actualQtyInput.value = '1';
        }

        // --- Initialization ---

        window.onload = function() {
            // Check if Firebase config is available (even if not used, keeps the environment stable)
            if (firebaseConfig) {
                // Placeholder for Firebase initialization
                console.log("Firebase config loaded. App ID:", appId);
                // Initialize Auth and DB if needed here
            } else {
                console.warn("Firebase config is missing, running in client-only mode.");
            }

            // Start the scanner logic
            startScanner();
        };

    </script>
</body>
</html>
